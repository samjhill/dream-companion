AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >-
  Dream Companion App - A Flask-based application deployed using AWS SAM

Parameters:
  StripeSecretKey:
    Type: String
    Description: Stripe secret key for payment processing
    NoEcho: true
  StripeWebhookSecret:
    Type: String
    Description: Stripe webhook secret for verifying webhook signatures
    NoEcho: true
  StripeMonthlyPriceId:
    Type: String
    Description: Stripe price ID for monthly subscription
  StripeQuarterlyPriceId:
    Type: String
    Description: Stripe price ID for quarterly subscription
  StripeYearlyPriceId:
    Type: String
    Description: Stripe price ID for yearly subscription

Globals:
  Function:
    Timeout: 10
    Runtime: python3.11

Resources:
  DreamCompanionApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'https://clarasdreamguide.com'"
        AllowCredentials: "'true'"
        MaxAge: "'300'"

  DreamCompanionFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: wsgi.handler
      Runtime: python3.11
      CodeUri: src/
      Environment:
        Variables:
          FLASK_ENV: production
          S3_BUCKET_NAME: dream.storage
          PREMIUM_TABLE_NAME: dream-companion-premium-users
          STRIPE_SECRET_KEY: !Ref StripeSecretKey
          STRIPE_WEBHOOK_SECRET: !Ref StripeWebhookSecret
          STRIPE_MONTHLY_PRICE_ID: !Ref StripeMonthlyPriceId
          STRIPE_QUARTERLY_PRICE_ID: !Ref StripeQuarterlyPriceId
          STRIPE_YEARLY_PRICE_ID: !Ref StripeYearlyPriceId
      Events:
        DreamCompanionApiEvent:
          Type: Api
          Properties:
            Path: /{proxy+}
            Method: ANY
            RestApiId: !Ref DreamCompanionApi
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: "2012-10-17"
          Statement:
            - Effect: "Allow"
              Action:
                - "s3:GetObject"
                - "s3:PutObject"
                - "s3:DeleteObject"
                - "s3:ListBucket"
              Resource: 
                - "arn:aws:s3:::dream.storage/*"
                - "arn:aws:s3:::dream.storage"
            - Effect: "Allow"
              Action:
                - "dynamodb:GetItem"
                - "dynamodb:PutItem"
                - "dynamodb:DeleteItem"
                - "dynamodb:UpdateItem"
                - "dynamodb:Query"
                - "dynamodb:Scan"
                - "dynamodb:CreateTable"
                - "dynamodb:DescribeTable"
              Resource: 
                - "arn:aws:dynamodb:*:*:table/dream-companion-premium-users"
                - "arn:aws:dynamodb:*:*:table/dream-companion-premium-users/*"

