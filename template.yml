AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >-
  Dream Companion App - A Flask-based application deployed using AWS SAM

Globals:
  Function:
    Timeout: 10
    Runtime: python3.11

Resources:
  DreamCompanionApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'https://clarasdreamguide.com'"
        AllowCredentials: "'true'"
        MaxAge: "'300'"


  DreamCompanionFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: wsgi.handler
      Runtime: python3.11
      CodeUri: src/
      Environment:
        Variables:
          FLASK_ENV: production
          S3_BUCKET_NAME: dream.storage
      Events:
        DreamCompanionApiEvent:
          Type: Api
          Properties:
            Path: /{proxy+}
            Method: ANY
            RestApiId: !Ref DreamCompanionApi
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: "2012-10-17"
          Statement:
            - Effect: "Allow"
              Action:
                - "s3:GetObject"
                - "s3:PutObject"
                - "s3:DeleteObject"
                - "s3:ListBucket"
              Resource: 
                - "arn:aws:s3:::dream.storage/*"
                - "arn:aws:s3:::dream.storage"

